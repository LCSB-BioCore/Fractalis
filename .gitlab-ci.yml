image: centos:latest

variables:
    PYPI_USER: SECURE
    PYPI_PASSWORD: SECURE

stages:
    - test
    - deploy
    - cleanup

before_script:
    # add epel-repo to centos
    - yum install -y epel-release
    - yum update -y
    # install dependencies
    - yum install -y rabbitmq-server redis python34 python34-pip python34-devel readline-devel R
    - pip3 install -e . -i https://pypi.lcsb.uni.lu/simple
    - R -e 'source("https://bioconductor.org/biocLite.R"); biocLite(); biocLite("limma")'
    # start services
    - redis-server --daemonize yes
    - rabbitmq-server -detached
    - celery worker -A fractalis:celery -D -l info

tests:
    stage: test
    script:
        - python3 setup.py test
        - flake8

pypi_package:
    stage: deploy
    script:
        - echo "[server-login]" > ~/.pypirc
        - echo "username=" ${PYPI_USER} >> ~/.pypirc
        - echo "password=" ${PYPI_PASSWORD} >> ~/.pypirc
        - python3 setup.py check sdist upload
    only:
        - tags
    except:
        - branches

rm_secrets:
    stage: cleanup
    when: always
    script:
        - rm -f ~/.pypirc
